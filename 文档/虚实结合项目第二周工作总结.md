# 虚实结合第二周工作报告

## 整体进程		

​	   本周师兄只有周一有时间，其余时间在出差，所以周一我去铁科院，把后面的操作步骤给大致学习了过来。这一部分的步骤比较繁琐并且需要大量的光学知识，也是师兄的核心工作，所以只交给我了怎么来进行操作，具体的原理并没有详细解释。

​	   对于生成强度图和深度图，按师兄的操作需要三个步骤。第一个步骤是通过zemax构建虚拟光学采集模型，利用虚拟光学采集模型来采集钢轨激光断面图像。zemax采集到的钢轨激光断面图像是CCD格式的。第二个步骤我们需要将其通过matlab转化为txt文件，然后通过halcon转化为tiff文件。第三个步骤是在转化为tiff格式文件之后，我们需要将这些钢轨激光断面图像来转化为强度图和深度图。每个钢轨激光断面图像有1mm，将一批钢轨激光断面图通过halcon进行处理可以生成。

本周主要工作：

* 编程实现了zemax批量自动采集文件夹下所有stl文件的断面图像的功能，采集好的断面图像会存放到单独的文件夹中。每个文件夹里面是这个stl文件存放的所有DDR文件。
*  把DDR文件用matlab批量自动化转化为txt格式的文件，这一部分交给了师弟在做，目前还没有完成。
* 将txt文件在halcon中给批量自动化的转化为tiff文件，这一部分也已经完成。
* 在缺陷模型生成中，添加了缺陷的大小变化（未完待续）。
* 将之前生成的点云文件需要通过matlab先行处理再通过python处理的过程优化为全部通过python处理，提高了集成程度。
* 编程实现了在halcon中批量自动化生成多个stl文件的强度图和深度图

​		目前感觉主要难点在于：

​		1.~~除了缺陷的自动化生成之外，zemax生成断面图的过程怎么批量自动化，halcon将断面图合成为强度图和深度图怎么批量自动化都还需要进一步的研究，而这两个软件需要的程序语言学习资料较少。~~

​		2.zemax生成断面图像的速度非常非常慢，一幅100mm的stl图生成100个断面图像需要400分钟。在师兄电脑上需要13分钟。这一部分师兄目前也没有什么好的解决方案。

​		3.真实图像目前没有，需要等到11月底才能开始采集。考虑到异常缺陷的稀缺性，估计采集到一定数量的有缺陷的真实数据集需要花费较长时间，如何能尽快的出实验成果是一个问题。

​		4.对整个项目的前景还不太明晰，要出什么成果？论文创新点怎么找？

## 通过zemax构建虚拟光学采集模型

* zemax配置准备

  在使用之前，首先需要对zemax进行一些配置。首先点击偏好设置，把语言调成中文，编辑器里面把允许外部程序修改镜头数据打上对勾。在非序列模式里面把光线追迹相对阈值强度改为1e-10，这个参数决定了光线在衰减为原来的百分之多少的时候 不在进行追迹。

* zemax进行钢轨激光断面图像采集

  ​		打开zemax-然后选择打开文件夹里面的师兄做好的配置文件（有两个，一个是存在装饰物的模型，一个是只有光源无装饰物的，在追迹的时候选择无装饰物的会快一些。），打开之后在非序列元件编辑器中把CAD零件那块的属性修改一下，在类型里面选择我们要打开的文件类型，然后在数据文件中选择我们要打开的数据文件（此数据文件需要预先存放在文档/zemax/objects/CADfile这个文件夹下），然后在CAD里面点击全部选择，再重命名为表面0即可。在导入模型文件之后，为了观察钢轨与光源和相机的位置关系是否正确，可以点击分析里面的非序列实体模型来观察。师兄的配置文件是基于1000钢轨做的，所以我们在制造缺陷的时候最好以此钢轨模型作为基准。光线追迹时每采集一行图像后，我们把钢轨在y方向上移动1mm，再进行下一步的采集。最后会采集到999张钢轨断面图像。

* 一些重要的参数及方法

  * 二极管光源中的分析光线条数和输出光线条数

    ​	分析光线条数是在非序列实体模型里面显示用的，这个值不重要，我们设置为200就会有比较好的展示效果了。输出光线条数指的是我们真实追迹的光线数量，这个经过实验验证，在我们选择500万的时候，生成的强度图和深度图效果是比较好的。再多影响速度也不会再有更高的性能提升。

  * 追迹的速度

       在1000mm的钢轨进行光线追迹，需要采集1000个钢轨断面图。在将真实追迹的光线数量设置为500万时，对于我们实验室的电脑i5-6300U，需要4分钟才能得到一个断面图，这样一幅图就需要66个小时才能生成。师兄那边的电脑，配置是i9的电脑，CPU很强劲，但是仍然需要8秒钟生成一个断面，那么一幅图需要2.2个小时生成一幅图。这个速度如果想用来生成大量图像，是不太可行的。因为一年一直运做也只能生成大约4000副图像。

  * DDR文件的查看
    * 对于生成的钢轨断面图，是DDR格式的，我们可以利用zemax中分析-探测器工具进行查看。我们首先点击探测器工具-加载DDR文件-选择我们想要查看的DDR文件将其加载到探测器里面。然后点击探测器查看器就可以了。如果这时候图像界面显示“未执行光线追迹的错误”，我们可以先关闭查看器，点击光线追迹，直接点击追迹，不用等他完成中止就行。这样再打开探测器查看器后就会正确显示。
    * 直接查看的图像断面图的白色相比于背景比较浅，这时候我们可以点击设置，将最大辐射度改的小一点。这样就会有一种对比度拉伸的效果，白色相比于背景颜色就会更加的突出。

  # 利用Halcon将断面图转化为深度图和强度图

  首先将DDR文件转化为txt文件，然后再转化为tiff文件。之后进行生成即可。

  注意halcon的许可证文件每个月初需要去halcon学习网，下载license。然后替换掉原先的license文件。

  # 自动化生成的逻辑

  **方法一**：zemax把特定文件夹下的钢轨，每一个钢轨生成的DDR文件保存到一个独立文件夹里面。然后用matlab将其转化为txt，再通过halcon将其转化为tiff格式，这两步骤实现的复杂度较高。之后还需要在halcon中对每一个文件夹下的tiff文件进行操作。

  **方法二**：zemax将特定文件夹下的所有钢轨生成的DDR文件都保存到一个文件夹下，生成的DDR文件按顺序命名。因为每隔99个DDR都是一个新的钢轨图，所以放在一起后也能通过序号来判断是否为同一个钢轨的图像。这样的好处是转化为txt和tiff的步骤简单了需要，只需要在halcon中按序号生成强度图和深度图就可以了。

  # 自动化生成时遇到的一些难点

  ​		自动化生成过程其实主要难点在于这两种语言都不太大众。学习资料不太容易找到。其实逻辑上十很简单的，但是在实现上遇到了很多问题导致花了比较久的时间对于缺陷生成的自动化这个周没有进行更多的尝试。

  ​		比如需要设置其物体的属性。这个函数在官方文档里面没有提到。而且因为软件比较小众，花了比较长时间才在谷歌里面找到了设置物体属性的函数[zemax一些特定函数](https://osphotonics.wordpress.com/2015/05/07/zemax-programming-language-3-10-non-sequential-components/)。通过这个函数，我们可以把物体属性里的类型那一栏的属性设置为CAD零件，然后数据文件则遍历我们目标文件夹下的所有.stl格式结尾的文件。

  ​		不过目前这个流程已经走通了，周末会对缺陷的自动化生成进行更深入的探究。

  # 任务列表

  * ~~学习zemax的宏编程语言，探索怎么将文件夹内的数据批量生成DDR文件。~~ 
  * ~~学习halcon的编程语言，探索怎么将ttif文件来批量合成固定大小的强度图和深度图。~~
  * 继续探究缺陷模型的自动化生成，考虑怎么样才会有更好的生成效果

# 修复bug

1.解决在生成缺陷时，没有用数组的深拷贝导致生成的缺陷会进行”偏移累计“的错误。

2.在ZPL编程时，解决直接写```setnscproperty 1,4,1,0,$str(fil)+".STL"```导致的生成的DDR文件只有空值的错误

# 任务分配

目前给两个师弟都安排了一些小任务：

* 大创小组主要让他们探究一下目前缺陷生成存在的一个问题：缺陷生成边缘存在突变怎么能缓和或者消除。还有就是目前从模型到强度图和深度图的转换流程速度上太慢，让他们再进一步研究一下之前3dmax直接渲染采图是否可以提高精度。
* 祺隆师弟主要让他实现一下把DDR格式文件通过matlab批量转化为txt文件的代码。

 

​	

 